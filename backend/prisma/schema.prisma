generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  BRAND
  KOL
}

enum CampaignStatus {
  DRAFT
  OPEN
  PAUSED
  CLOSED
  COMPLETED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  fullName        String?   @map("full_name")
  role            Role      @default(KOL)
  avatar          String?
  bio             String?
  phone           String?
  address         String?   // Địa chỉ nhận hàng
  socialLink      String?   @map("social_link")
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  isBanned        Boolean   @default(false) @map("is_banned")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  campaigns       Campaign[]
  applications    Application[]
  reviewsWritten  Review[]      @relation("ReviewAuthor")
  reviewsReceived Review[]      @relation("ReviewTarget")
  notifications   Notification[]
  sentMessages    ChatMessage[] @relation("SentMessages")

  @@map("users")
  @@index([email])
}

model Campaign {
  id          String         @id @default(uuid())
  title       String
  description String
  requirements String?
  budget      Float          // Nếu = 0 nghĩa là Tặng sản phẩm/Thương lượng
  deadline    DateTime?
  status      CampaignStatus @default(OPEN)
  
  // NEW: Album ảnh sản phẩm (V2.4)
  images      String[]       @default([]) @map("images")
  
  brandId     String         @map("brand_id")
  brand       User           @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  applications Application[]

  @@map("campaigns")
  @@index([brandId])
}

model Application {
  id          String            @id @default(uuid())
  coverLetter String?           @map("cover_letter")
  price       Float?
  status      ApplicationStatus @default(PENDING)

  // Booking Flow Data
  trackingCode     String?   @map("tracking_code")
  isProductReceived Boolean  @default(false) @map("is_product_received")
  submissionLink   String?   @map("submission_link")
  
  campaignId  String            @map("campaign_id")
  campaign    Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  kolId       String            @map("kol_id")
  kol         User              @relation(fields: [kolId], references: [id], onDelete: Cascade)

  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  reviews     Review[] 
  messages    ChatMessage[]

  @@map("applications")
  @@unique([campaignId, kolId])
}

model Review {
  id            String   @id @default(uuid())
  rating        Int
  comment       String?
  
  applicationId String   @map("application_id")
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  authorId      String   @map("author_id")
  author        User     @relation("ReviewAuthor", fields: [authorId], references: [id])

  targetId      String   @map("target_id")
  target        User     @relation("ReviewTarget", fields: [targetId], references: [id])

  createdAt     DateTime @default(now()) @map("created_at")

  @@map("reviews")
}

model Notification {
  id        String   @id @default(uuid())
  content   String
  isRead    Boolean  @default(false) @map("is_read")
  type      String?
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

model ChatMessage {
  id            String      @id @default(uuid())
  content       String
  senderId      String      @map("sender_id")
  sender        User        @relation("SentMessages", fields: [senderId], references: [id])
  applicationId String      @map("application_id")
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("chat_messages")
}