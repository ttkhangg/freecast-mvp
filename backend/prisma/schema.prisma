// 1. Cấu hình kết nối
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Enum trạng thái
enum Role {
  ADMIN
  BRAND
  KOL
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  LOCKED
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  SHIPPING
  RECEIVED
  SUBMITTED
  COMPLETED
  PAID
  REJECTED
}

// 3. Models
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          Role      @default(BRAND)
  isVerified    Boolean   @default(false)
  isBanned      Boolean   @default(false) // NEW: Cờ chặn đăng nhập vĩnh viễn (Tech Debt #4)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  brandProfile  BrandProfile?
  kolProfile    KolProfile?
  notifications Notification[]
  messages      Message[]
}

// Model Thông báo
model Notification {
  id        String   @id @default(uuid())
  userId    String   // Người nhận thông báo
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?  // Link đích khi bấm vào
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model BrandProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  companyName String
  logo        String?
  website     String?
  industry    String?
  description String?
  taxCode     String?
  address     String?
  phone       String?
  
  user        User     @relation(fields: [userId], references: [id])
  campaigns   Campaign[]
}

model KolProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  fullName    String
  avatar      String?
  bio         String?
  categories  String[]
  platforms   Json?
  followers   Int      @default(0)
  
  // Thông tin liên hệ & Thanh toán
  phone       String?
  socialLink  String?  // Link kênh chính (Tech Debt #9)
  address     String?
  city        String?
  bankName    String?
  bankAccount String?
  
  user        User     @relation(fields: [userId], references: [id])
  applications Application[]
}

model Campaign {
  id            String          @id @default(uuid())
  brandId       String
  title         String
  description   String          @db.Text
  productName   String
  productImage  String?
  productValue  String
  requirements  String          @db.Text
  platform      String
  status        CampaignStatus  @default(DRAFT)
  deadline      DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  brand         BrandProfile    @relation(fields: [brandId], references: [id])
  applications  Application[]
}

model Application {
  id            String            @id @default(uuid())
  campaignId    String
  kolId         String
  status        ApplicationStatus @default(PENDING)
  
  // Logistics
  shippingCode  String?
  carrier       String?
  
  // Submission
  contentLink   String?
  submitNote    String?
  
  // Timestamps
  approvedAt    DateTime?
  shippedAt     DateTime?
  receivedAt    DateTime?
  submittedAt   DateTime?
  completedAt   DateTime?

  // Review (Đánh giá 2 chiều)
  rating        Int?              // Brand đánh giá KOL
  review        String?
  kolRating     Int?              // KOL đánh giá Brand
  kolReview     String?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  campaign      Campaign          @relation(fields: [campaignId], references: [id])
  kol           KolProfile        @relation(fields: [kolId], references: [id])
  messages      Message[]

  @@unique([campaignId, kolId])
}

// Model Tin nhắn
model Message {
  id            String      @id @default(uuid())
  content       String      @db.Text
  senderId      String
  applicationId String
  createdAt     DateTime    @default(now())

  sender        User        @relation(fields: [senderId], references: [id])
  application   Application @relation(fields: [applicationId], references: [id])
}